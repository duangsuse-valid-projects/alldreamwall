<!DOCTYPE html>
<!-- Copyright(C) 2018 duangsuse
alldream.html is a standalone web fortend tool for viewing alldream workshare platform worklist
Licensed under LGPLv3 -->
<html lang="zh-cn" dir="ltr">

<head>
  <title>AllDream 傲梦展览墙</title>
  <meta charset="utf-8">
  <meta name="description" content="欣赏 4k+ 个中国孩子的神奇作品">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta property="og:site_name" content="傲梦编程 BigWall">
  <meta property="og:title" content="傲梦编程 BigWall">
  <meta property="og:description" content="欣赏 4k+ 个孩子的神奇作品">
  <meta name="theme-color" content="#2196F3">
  <meta content="index,follow" name="robots">
  <meta content="telphone=no, email=no" name="format-detection">
  <meta name="format-detection" content="telephone=no">
  <link rel="icon" href="https://all-dream.com/favicon.ico">
  <!-- MDUI <3 duangsuse -->
  <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css">
  <script src="https://cdnjs.loli.net/ajax/libs/mdui/0.4.1/js/mdui.min.js"></script>
  <!-- Community libraries -->
  <script src="https://cdnjs.loli.net/ajax/libs/downloadjs/1.4.8/download.js"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script>
    var $$ = mdui.JQ;
    localStorage['page'] = localStorage['page'] || 25
    localStorage['cate'] = localStorage['cate'] || 'scratch'
    function s(set) { localStorage['cate'] = set; $$('#title')[0].text = "作品目录" + "（" + set + "）" }
  </script>
  <style>
    .grid-item {
      width: 294px;
    }
  </style>
</head>

<body class="mdui-theme-primary-blue mdui-theme-accent-pink">
  <div mdui-headroom="" class="mdui-appbar">
    <div class="mdui-toolbar mdui-color-theme">
      <a id="title" class="mdui-text-color-white mdui-typo-title" mdui-tooltip="{content: '显示作品计数'}">作品目录</a>
      <div class="mdui-toolbar-spacer"></div>
      <a id="go-back" onclick="if (pageNum > 1) { pageNum--; mdui.snackbar('后退一页：' + pageNum, { timeout: 500 }) } else { mdui.snackbar('已经到第一页了', { timeout: 700 }) }"
        class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '后退一页'}">
        <i class="mdui-text-color-white mdui-icon material-icons">arrow_back</i>
      </a>
      <a id="pagnum" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '每页显示条数'}">
        <i class="mdui-text-color-white mdui-icon material-icons">featured_play_list</i>
      </a>
      <a id="btn-category" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#set-category'}" mdui-tooltip="{content: '分类'}">
        <i class="mdui-text-color-white mdui-icon material-icons">folder</i>
      </a>
      <a id="refresh" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '刷新'}">
        <i class="mdui-text-color-white mdui-icon material-icons">refresh</i>
      </a>
    </div>
  </div>

  <script>
    function mapSid(name) {
      if (name == 'scratch')
        return 1
      else if (name == 'turtle')
        return 2
      else if (name == 'mindmap')
        return 0
      else if (name == 'recommended')
        return 6
      else
        return 1
    }
    function getSidLogo(sid) {
      if (sid == '1')
        return '🐱'
      else if (sid == '2')
        return '🐢'
      else if (sid == '0')
        return '🤔'
      else if (sid == '6')
        return '🌠'
      else
        return '❓'
    }
    function tfmt(date) {
      return date.getFullYear() + " 年 " + (date.getMonth() + 1) + " 月 " + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds()
    }
    // should use dark style from 19:00 to 6:00
    function shouldApplyDarkStyle() {
      var conf = localStorage['night']
      if (conf != null) {
        if (conf == false.toString())
          return false;
        else return true;
      }
      var dh = new Date();
      var nightBegin = localStorage['nightBegin'] || 19
      var nightEnd = localStorage['nightEnd'] || 6
      return dh.getHours() >= nightBegin && dh.getHours() <= nightEnd
    }

    MDUI_DARK_CLASS = 'mdui-theme-layout-dark'

    // call this to apply dark style automatically
    function autodark() {
      var body = mdui.JQ('body')[0]
      var cls = body.classList
      if (shouldApplyDarkStyle())
        cls.add(MDUI_DARK_CLASS)
      else
        cls.remove(MDUI_DARK_CLASS)
    }

    function rlist(page, fun) {
      var size = localStorage['page']
      var cate = localStorage['cate']
      var api = 'https://all-dream.com/rest/share/list'
      start_time = new Date()
      console.log("Grabbing list at " + start_time)
      $$.ajax({
        method: 'POST',
        url: api,
        data: {
          rows: size,
          shareType: cate == 'all' ? null : mapSid(cate),
          bigType: cate == 'all' ? 3 : 1,
          page: pageNum
        },
        success: function (data) {
          fun(JSON.parse(data));
          end_time = new Date()
          console.log("Finished at " + end_time + " in " + (end_time - start_time) + "ms (size is " + localStorage['page'] + ")")
        }
      });
    }

    $$('#pagnum')[0].onclick = function () {
      var old_num = localStorage['page']
      pagnum_ok = function (t, d) {
        var n = Number(t)
        if (n != 0 && Number.isNaN(n)) {
          localStorage['page'] = n
          mdui.snackbar("你设置了新每页项目数：" + n, { buttonText: 'undo', onButtonClick: function () { localStorage['page'] = old_num } })
        } else { mdui.snackbar("不能设置为 0，请不要填为空") }
      }
      var cancel = function (t, d) {
        d.close()
      }
      diag_pagnum = mdui.prompt("请输入每页显示项目数（当前 " + localStorage['page'] + " 项/页）", pagnum_ok, cancel, { confirmOnEnter: true })
    }

    $$('#title')[0].onclick = function () {
      $$.ajax({
        method: 'POST',
        url: 'https://all-dream.com/rest/share/queryCount',
        success: function (data) {
          var obj = JSON.parse(data)
          var toolset = "<p><div class=\"mdui-typo\"><h3>查询小工具：</h3><p>根据 <em>UID</em> 获取用户详细信息<p>根据 <em>SID</em> 获取分享信息<p>查询宝石榜<p>查询金币榜<p>这是由 <a href=\"https://t.me/duangsuse\">duangsuse</a> 开发的 <a href=\"https://all-dream.com\">傲梦</a> 分享项目数据查询工具，以 <strong>GNU LGPL-3.0</strong> 共享协议开放源代码<p><small>感谢 <strong>MDUI、download.js、Masonry</strong> 提供的部分特性支持</small></div>"
          mdui.alert("<a class=\"mdui-typo\">总共有 <code>" + obj['total'] + "</code> 个作品，其中 Scaratch <code>" + obj['SB2Count'] + "</code> 个，TJS <code>" + obj['JSCount'] + "</code> 个，思维导图 <code>" + obj['mindMappingCount'] + "</code> 个，推荐 <code>" + obj['promote'] + "</code> 个</a>" + toolset);
        }
      });
    }

    pageNum = 1
    bin = []
    $$('#refresh')[0].onclick = function () {
      bin = []
      var grab_snack = mdui.snackbar("正在从远端获取列表...")
      // Angry! 为啥我不知道怎么定义局部变量
      var start_time2 = new Date()
      rlist(pageNum, function (d) {
        grab_snack.close()
        mdui.snackbar("成功从远端获得列表，用时 " + (new Date() - start_time2) / 1000 + " 秒")
        var buf = ""
        for (var k in d['list']) {
          var v = d['list'][k]
          // console.log(v)
          bin[k] = v
          item = fill('https://all-dream.com/' + v['coverUrl'], v['courseTypeName'] == null ? '无课程分类' : v['courseTypeName'] + ' - ' + v['name'] + '（' + v['grade'] + '）', v['shareTitle'] + ' | ⭐️ ' + v['star'] + ' 📝 ' + v['score'] + ' 🕐 ' + tfmt(new Date(v['createTime'])) + ' 👁 ' + v['visit'] + ' 💎 ' + v['gold'] + ' | ' + (v['promote'] == 1 ? '👍' : '') + (v['sex'] == '1' ? '👦🏻' : '👧🏻') + getSidLogo(v['shareType']), v['shareContent'], "window.location='https://all-dream.com/'+bin[" + k + "]['fileUrl']", "tmp=bin[" + k + "];download(JSON.stringify(tmp),'json_'+tmp['shareTitle']+'_'+tmp['name'],'application/json')")
          buf += wrap(item)
        }
        setlist(buf);
        $$.showOverlay();
        $$.throttle(function () { refresh_mash(); $$.hideOverlay(); }, 1000)();
      });
      autodark();
    }

    // auto apply dark style
    autodark();

    // hotkeys
    function do_refresh() { $$('#refresh').trigger('click') }
    document.onkeyup = function (k) {
      // Enter to refresh
      if (k.code == 'Enter') {
        if (k.target == $$('body')[0]) {
          do_refresh();
        } else {
          if (typeof diag_pagnum != 'undefined') {
            // deprecated
            // diag_pagnum.close();
            // pagnum_ok();
          }
        }
      }

      // console.log(k.code);
      switch (k.code) {
        case 'KeyM':
          $$('#title').trigger('click');
          break
        case 'ArrowRight':
          $$('.mdui-fab').trigger('click');
          break
        case 'ArrowLeft':
          $$('#go-back').trigger('click');
          break
        case 'KeyC':
          $$('#btn-category').trigger('click');
          break
        case 'KeyT':
          $$('#pagnum').trigger('click');
      }
    }
  </script>

  <script>
    var template = '<div class="mdui-card"><div class="mdui-card-media"><img src="@img@"/></div><div class="mdui-card-primary"><div class="mdui-card-primary-title">@title@</div><div class="mdui-card-primary-subtitle">@subtitle@</div></div><div class="mdui-card-content">@desc@</div><div class="mdui-card-actions"><button onclick="@a1@" class="mdui-btn mdui-ripple mdui-color-theme-accent mdui-btn-raised"><i class="mdui-icon mdui-icon-left material-icons">file_download</i> 下载</button><button onclick="@a2@" class="mdui-btn mdui-btn-raised mdui-ripple"><i class="mdui-icon mdui-icon-left material-icons">info_outline</i> 源数据</button></div></div>'
    function fill(img, title, subt, desc, a1, a2) {
      return template.replace('@img@', img)
        .replace('@title@', title)
        .replace('@subtitle@', subt)
        .replace('@desc@', desc)
        .replace('@a1@', a1)
        .replace('@a2@', a2);
    }
    function setlist(t) {
      list.innerHTML = t
    }
    function wrap(h) {
      return '<div class="grid-item mdui-shadow-5 mdui-grid-tile mdui-grid-list">' + h + '</div>'
    }
  </script>

  <!-- Main list -->
  <div id="list" style="padding: 10px;" class="grid mdui-container-fluid"></div>
  <script>var list = $$('#list')[0]</script>
  <script>
    function refresh_mash() {
      var msnry = new Masonry(list, {
        itemSelector: '.grid-item',
        columnWidth: 30
      });
    }
  </script>

  <button onclick="pageNum++; mdui.snackbar('前进一页：' + pageNum, { timeout: 500 })" class="mdui-fab mdui-fab-fixed mdui-color-theme-accent mdui-ripple">
    <i class="mdui-icon material-icons">arrow_forward</i>
  </button>

  <div class="mdui-dialog" id="set-category">
    <div class="mdui-dialog-title">请选择要显示的分类</div>
    <div class="mdui-dialog-content mdui-typo">您可以选择只显示指定类型的项目，包括
      <code>全部、MindMap、Scratch、JS Turtle、推荐</code>
    </div>
    <div class="mdui-dialog-actions mdui-dialog-actions-stacked">
      <button onclick="s('all')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show All | 显示全部</button>
      <button onclick="s('mindmap')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show Mind-Maps | MindMap</button>
      <button onclick="s('scratch')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show Scratch Projects | Scratch </button>
      <button onclick="s('turtle')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show JS Turtle Projects | JS Turtle</button>
      <button onclick="s('recommended')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Recommended Projects | 推荐项目</button>
      <button class="mdui-btn mdui-ripple" mdui-dialog-close="">Keep settings, close dialog | 保持现状</button>
    </div>
  </div>
</body>

</html>
