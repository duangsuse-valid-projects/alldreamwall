<!DOCTYPE html>
<!-- Copyright(C) 2018 duangsuse
alldream.html is a standalone web fortend tool for viewing alldream workshare platform worklist
Licensed under LGPLv3 -->
<html lang="zh-cn" dir="ltr">

<head>
    <!-- Basic tags -->
    <title>AllDream ÂÇ≤Ê¢¶Â±ïËßàÂ¢ô</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">

    <!-- OpenGraph & SEO -->
    <meta name="description" content="Ê¨£Ëµè 4k+ ‰∏™‰∏≠ÂõΩÂ≠©Â≠êÁöÑÁ•ûÂ•á‰ΩúÂìÅ">
    <link rel="icon" href="https://all-dream.com/favicon.ico">
    <meta property="og:site_name" content="ÂÇ≤Ê¢¶ÁºñÁ®ã BigWall">
    <meta property="og:title" content="ÂÇ≤Ê¢¶ÁºñÁ®ã BigWall">
    <meta property="og:description" content="Ê¨£Ëµè 4k+ ‰∏™Â≠©Â≠êÁöÑÁ•ûÂ•á‰ΩúÂìÅ">

    <!-- Useful tags -->
    <meta name="theme-color" content="#2196F3">
    <meta content="index,follow" name="robots">
    <meta content="telphone=no, email=no" name="format-detection">
    <meta name="format-detection" content="telephone=no">

    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <!-- MDUI <3 duangsuse -->
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css">
    <script src="https://cdnjs.loli.net/ajax/libs/mdui/0.4.1/js/mdui.min.js"></script>
    <!-- Community libraries -->
    <script src="https://cdnjs.loli.net/ajax/libs/downloadjs/1.4.8/download.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

    <!-- Begin MIT Licensed library: mafintosh/json-markup -->
    <style>
        .json-markup {
            line-height: 17px;
            font-size: 13px;
            font-family: monospace;
            white-space: pre;
        }

        .json-markup-key {
            font-weight: bold;
        }

        .json-markup-bool {
            color: #FF80AB;
        }

        .json-markup-string {
            color: #4CAF50;
        }

        .json-markup-null {
            color: #BDBDBD;
        }

        .json-markup-number {
            color: #448AFF;
        }
    </style>
    <script>
        var INDENT = '    '

        function inlineRule(objRule) {
            var str = ''
            Object.keys(objRule).forEach(function (rule) {
                str += rule + ':' + objRule[rule] + ';'
            })
            return str
        }

        function Stylize(styleFile) {
            function styleClass(cssClass) {
                return 'class="' + cssClass + '"'
            }

            function styleInline(cssClass) {
                return 'style="' + inlineRule(styleFile['.' + cssClass]) + '"'
            }

            if (!styleFile) return styleClass
            return styleInline
        }

        function type(doc) {
            if (doc === null) return 'null'
            if (Array.isArray(doc)) return 'array'
            if (typeof doc === 'string' && /^https?:/.test(doc)) return 'link'
            if (typeof doc === 'number' && /\(|\)|\d{13}/.test(doc)) return 'maybe_datenum'
            if (typeof doc === 'object' && typeof doc.toISOString === 'function') return 'date'

            return typeof doc
        }

        function escape(str) {
            return str.replace(/</g, '&lt;').replace(/>/g, '&gt;')
        }

        function ppJson(doc, styleFile) {
            var indent = ''
            var style = Stylize(styleFile)

            var forEach = function (list, start, end, fn) {
                if (!list.length) return start + ' ' + end

                var out = start + '\n'

                indent += INDENT
                list.forEach(function (key, i) {
                    out += indent + fn(key) + (i < list.length - 1 ? ',' : '') + '\n'
                })
                indent = indent.slice(0, -INDENT.length)

                return out + indent + end
            }

            function visit(obj) {
                if (obj === undefined) return ''

                switch (type(obj)) {
                    case 'boolean':
                        return '<span ' + style('json-markup-bool') + '>' + obj + '</span>'

                    case 'number':
                        return '<span ' + style('json-markup-number') + '>' + obj + '</span>'

                    case 'date':
                        return '<span class="json-markup-string">"' + escape(obj.toISOString()) + '"</span>'

                    case 'maybe_datenum':
                        return '<span class="json-markup-number">' + obj + '</span>' + ',<a style="color: #607D8B"> // Maybe date: ' + tfmt(new Date(obj)) + '</a>'

                    case 'null':
                        return '<span ' + style('json-markup-null') + '>null</span>'

                    case 'string':
                        return '<span ' + style('json-markup-string') + '>"' + escape(obj.replace(/\n/g, '\n' + indent)) + '"</span>'

                    case 'link':
                        return '<span ' + style('json-markup-string') + '>"<a href="' + escape(obj) + '">' + escape(obj) + '</a>"</span>'

                    case 'array':
                        return forEach(obj, '[', ']', visit)

                    case 'object':
                        var keys = Object.keys(obj).filter(function (key) {
                            return obj[key] !== undefined
                        })

                        return forEach(keys, '{', '}', function (key) {
                            if (emitter != null) {
                                var eresult = emitter(key, obj[key]);
                                if (eresult == '')
                                    return '<span ' + style('json-markup-key') + '>"' + key + '":</span> ' + visit(obj[key])
                                else
                                    return '<span ' + style('json-markup-key') + '>"' + key + '":</span> ' + visit(obj[key]) + ', <a style="color: #607D8B">// ' + eresult + '</a>'
                            } else {
                                return '<span ' + style('json-markup-key') + '>"' + key + '":</span> ' + visit(obj[key])
                            }
                        })
                }

                return ''
            }

            return '<div ' + style('json-markup') + '>' + visit(doc) + '</div>'
        }
    </script>
    <!-- end -->

    <!-- Small intialize script -->
    <script>
        var $$ = mdui.JQ;
        localStorage['page'] = localStorage['page'] || 25
        localStorage['cate'] = localStorage['cate'] || 'scratch'
        function s(set) { localStorage['cate'] = set; $$('#title')[0].text = "‰ΩúÂìÅÁõÆÂΩï" + "Ôºà" + set + "Ôºâ" }
        function getQueryParams(qs) {
            qs = qs.split('+').join(' ');

            var params = {},
                tokens,
                re = /[?&]?([^=]+)=([^&]*)/g;

            while (tokens = re.exec(qs)) {
                params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
            }

            return params;
        }
        // Query map
        var query = getQueryParams(document.location.search);
        emitter = null // global comment emitter

        // Set comment emitter
        function setCommentEmitter(funame) {
            emitter = plugin_emitters[funame]; // set emitter
        }

        // plugin array
        var plugins = localStorage['plugins'] || '[]'
        plugins = JSON.parse(plugins);
        
        // Ruby dafa is good
        puts = console.log
        Array.prototype.each = Array.prototype.forEach
    </script>
    <!-- Configure item display size -->
    <style>
        .grid-item {
            width: 294px;
        }
    </style>
</head>

<!-- AppBar -->

<body class="mdui-theme-primary-blue mdui-theme-accent-pink">
    <div mdui-headroom="" class="mdui-appbar">
        <div class="mdui-toolbar mdui-color-theme">
            <!-- Title -->
            <a id="title" class="mdui-text-color-white mdui-typo-title" mdui-tooltip="{content: 'ÊòæÁ§∫‰ΩúÂìÅËÆ°Êï∞'}">‰ΩúÂìÅÁõÆÂΩï</a>
            <div class="mdui-toolbar-spacer"></div>
            <!-- Action buttons -->
            <a id="go-back" onclick="if (pageNum > 1) { pageNum--; mdui.snackbar('ÂêéÈÄÄ‰∏ÄÈ°µÔºö' + pageNum, { timeout: 500 }) } else { mdui.snackbar('Â∑≤ÁªèÂà∞Á¨¨‰∏ÄÈ°µ‰∫Ü', { timeout: 700 }) }"
                class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'ÂêéÈÄÄ‰∏ÄÈ°µ'}">
                <i class="mdui-text-color-white mdui-icon material-icons">arrow_back</i>
            </a>
            <a id="pagnum" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'ÊØèÈ°µÊòæÁ§∫Êù°Êï∞'}">
                <i class="mdui-text-color-white mdui-icon material-icons">featured_play_list</i>
            </a>
            <a id="btn-category" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#set-category'}" mdui-tooltip="{content: 'ÂàÜÁ±ª'}">
                <i class="mdui-text-color-white mdui-icon material-icons">folder</i>
            </a>
            <a id="refresh" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'Âà∑Êñ∞'}">
                <i class="mdui-text-color-white mdui-icon material-icons">refresh</i>
            </a>
        </div>
    </div>

    <script>
        // ShareType ID Processing
        function mapSid(name) {
            if (name == 'scratch')
                return 1
            else if (name == 'turtle')
                return 2
            else if (name == 'mindmap')
                return 0
            else if (name == 'recommended')
                return 6
            else
                return 1
        }
        function getSidLogo(sid) {
            if (sid == '1')
                return 'üê±'
            else if (sid == '2')
                return 'üê¢'
            else if (sid == '0')
                return 'ü§î'
            else if (sid == '6')
                return 'üå†'
            else
                return '‚ùì'
        }
        function tfmt(date) {
            return date.getFullYear() + " Âπ¥ " + (date.getMonth() + 1) + " Êúà " + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds()
        }
        // should use dark style from 19:00 to 6:00
        function shouldApplyDarkStyle() {
            var conf = localStorage['night']
            if (conf != null) {
                if (conf == false.toString())
                    return false;
                else return true;
            }
            var dh = new Date();
            var nightBegin = localStorage['nightBegin'] || 19
            var nightEnd = localStorage['nightEnd'] || 6
            return dh.getHours() >= nightBegin && dh.getHours() <= 24 || dh.getHours() <= nightEnd
        }

        MDUI_DARK_CLASS = 'mdui-theme-layout-dark'

        // call this to apply dark style automatically
        function autodark() {
            var body = mdui.JQ('body')[0]
            var cls = body.classList
            if (shouldApplyDarkStyle())
                cls.add(MDUI_DARK_CLASS)
            else
                cls.remove(MDUI_DARK_CLASS)
        }

        // main list API client
        var api = 'https://all-dream.com/rest/share/list'
        function rlist(page, fun) {
            var size = localStorage['page']
            var cate = localStorage['cate']
            start_time = new Date()
            console.log("Grabbing list at " + start_time)
            $$.ajax({
                method: 'POST',
                url: api,
                data: {
                    rows: size,
                    shareType: cate == 'all' ? null : mapSid(cate),
                    bigType: cate == 'all' ? 3 : 1,
                    page: pageNum
                },
                success: function (data) {
                    fun(JSON.parse(data));
                    end_time = new Date()
                    console.log("Finished at " + end_time + " in " + (end_time - start_time) + "ms (size is " + localStorage['page'] + ")")
                }
            });
        }

        // Error snackbar
        $$(document).ajaxError(function (event, xhr, options) {
            // xhr: XMLHttpRequest ÂØπË±°
            // options: AJAX ËØ∑Ê±ÇÁöÑÈÖçÁΩÆÂèÇÊï∞
            mdui.snackbar("‰ªéËøúÁ´ØÊãâÂèñÊï∞ÊçÆÂ§±Ë¥•Ôºö" + (xhr.statusText == '' ? 'Êú™Áü•ÂéüÂõ†' : xhr.statusText), {
                timeout: 1000, buttonText: 'ËØ¶ÁªÜ‰ø°ÊÅØ', onClick: function () {
                    setlist(xhr.toSource());
                }
            });
        });

        // Áî®Êù•ÂàõÂª∫Ê∑∑ÂêàÂáΩÊï∞ÁöÑÈ´òÈò∂ÂáΩÊï∞
        // @arg func: Ë¢´ÂÜÖËÅîÁöÑÂáΩÊï∞
        // @arg chain_fun: ÁõÆÊ†áÂáΩÊï∞
        // @return ÁîüÊàêÁöÑÊ∑∑ÂêàÂáΩÊï∞Èó≠ÂåÖ
        function mixture(func, chain_fun) {
            return function (arg1) {
                return func(chain_fun(arg1))
            }
        }
        // Curry for mixture
        function mk_mixture(chain_fun) {
            return function (func) {
                return mixture(func, chain_fun)
            }
        }

        // Áî®Êù•Ê∑ªÂä† JSON Ëß£Á†ÅÂäüËÉΩÁöÑÈ´òÈò∂ÂáΩÊï∞
        json_decode_chain = mk_mixture(JSON.parse)

        // Billboard type 1 -> gold, 2 -> gem
        var bill_api = 'https://all-dream.com/rest/shareUserInfo/list'
        function rlist_billboard(type, fun) {
            var size = localStorage['page']
            $$.ajax({
                method: 'POST',
                url: bill_api,
                data: {
                    type: type,
                    rows: size,
                    page: pageNum
                },
                success: json_decode_chain(fun)
            });
        }

        // Query shared messages
        var mesg_api = 'https://all-dream.com/rest/shareRecentMessage/list'
        function rlist_msg(fun) {
            var size = localStorage['page']
            $$.ajax({
                method: 'POST',
                url: mesg_api,
                data: {
                    rows: size,
                    page: pageNum
                },
                success: json_decode_chain(fun)
            });
        }

        // Query user information
        // ËÄÉËôëÂà∞ User ID ÊòØ‰∏çÂåÖÂê´ÁâπÊÆäÁ¨¶Âè∑ÁöÑÂìàÂ∏åÂÄºÔºå‰∏çÈúÄË¶Å escape ‰∫ÜÔºå‰ΩÜÂÆûÈôÖÁîü‰∫ß‰∏≠‰∏çÂª∫ËÆÆËøô‰πàÂÅöÔºàXD
        var uq_api = 'https://all-dream.com/rest/student/info?studentId=xxxx'
        function ruser(id, fun) {
            $$.ajax({
                method: 'POST',
                url: uq_api.replace('xxxx', id || ''),
                success: json_decode_chain(fun)
            });
        }

        var pq_api = 'https://all-dream.com/rest/share/queryById?id=xxxx'
        function rproj(id, fun) {
            $$.ajax({
                method: 'POST',
                url: pq_api.replace('xxxx', id || ''),
                success: json_decode_chain(fun)
            });
        }

        // Set list view HTML text to t
        function setlist(t) {
            list.innerHTML = t
        }

        // Show json as list
        pplist = mixture(setlist, ppJson)

        // cancel dialog
        function mdui_cancel(t, d) { d.close(); }

        // JSON pp based util views
        function uid_view() {
            alert_title.close();
            mdui.prompt("ËØ∑ËæìÂÖ•Ë¶ÅÊü•ËØ¢ÁöÑ UIDÔºàLike <em>d21ad8f718264854a4dee4dc4a11badd</em>Ôºâ", function (t, d) {
                ruser(t, function (d) { pplist(d) });
            }, mdui_cancel, { confirmOnEnter: true });
        }

        function share_view() {
            alert_title.close();
            mdui.prompt("ËØ∑ËæìÂÖ•Ë¶ÅÊü•ËØ¢ÁöÑ SIDÔºàLike <em>bb2de65d43fb4a9e82ce460b7c830d67</em>Ôºâ", function (t, d) {
                rproj(t, function (d) { pplist(d) });
            }, mdui_cancel, { confirmOnEnter: true });
        }

        function gem_view() {
            if (typeof alert_title != 'undefined')
                alert_title.close();
            // mdui.snackbar("Work In Progress")
            rlist_billboard(1, function (d) { pplist(d) });
        }

        function gold_view() {
            if (typeof alert_title != 'undefined')
                alert_title.close();
            // mdui.snackbar("Work In Progress");
            rlist_billboard(2, function (d) { pplist(d) });
        }

        function slist_view() {
            if (typeof alert_title != 'undefined')
                alert_title.close();
            rlist_msg(function (d) { pplist(d) });
        }

        function mlist_view() {
            if (typeof alert_title != 'undefined')
                alert_title.close();
            rlist(pageNum, function (d) { pplist(d) });
        }

        // Remove ALL plugins!
        function remove_plugins() {
            if (typeof alert_title != 'undefined' && plugins.length != 0)
                alert_title.close();
            mdui.snackbar(plugins.length != 0 ? "Â∑≤ÁªèÁßªÈô§ " + plugins.length + " ‰∏™Êèí‰ª∂" : "Ê≤°ÊúâÂ§ñÊåÇÊèí‰ª∂ÈúÄË¶ÅÁßªÈô§");
            localStorage.removeItem('plugins');
        }
        // end util views

        // pageNumber changer
        $$('#pagnum')[0].onclick = function () {
            var old_num = localStorage['page']
            pagnum_ok = function (t, d) {
                var n = Number(t)
                if (n != 0 && !Number.isNaN(n)) {
                    localStorage['page'] = n
                    mdui.snackbar("‰Ω†ËÆæÁΩÆ‰∫ÜÊñ∞ÊØèÈ°µÈ°πÁõÆÊï∞Ôºö" + n, { buttonText: 'undo', onButtonClick: function () { localStorage['page'] = old_num } })
                } else { mdui.snackbar("‰∏çËÉΩËÆæÁΩÆ‰∏∫ 0ÔºåËØ∑‰∏çË¶ÅÂ°´‰∏∫Á©∫") }
            }
            var cancel = function (t, d) {
                d.close()
            }
            diag_pagnum = mdui.prompt("ËØ∑ËæìÂÖ•ÊØèÈ°µÊòæÁ§∫È°πÁõÆÊï∞ÔºàÂΩìÂâç " + localStorage['page'] + " È°π/È°µÔºâ", pagnum_ok, cancel, { confirmOnEnter: true })
        }

        var toolset = "<p><div class=\"mdui-typo\"><h3>Êü•ËØ¢Â∞èÂ∑•ÂÖ∑Ôºö</h3><p>Ê†πÊçÆ <em>UID</em> Ëé∑ÂèñÁî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ <a onclick=\"uid_view()\">üë§</a><p>Ê†πÊçÆ <em>SID</em> Ëé∑ÂèñÂàÜ‰∫´‰ø°ÊÅØ <a onclick=\"share_view()\">üìÑ</a><p>Êü•ËØ¢ÂÆùÁü≥Ê¶ú <a onclick=\"gem_view()\">üíé</a><p>Êü•ËØ¢ÈáëÂ∏ÅÊ¶ú <a onclick=\"gold_view()\">üîë</a><p>Êü•ËØ¢ÂàÜ‰∫´Ê∂àÊÅØ <a onclick=\"slist_view()\">üéâ</a><p>Ê£ÄÊü•ÂàÜ‰∫´ÂàóË°®Ê∫ê‰ª£Á†Å <a onclick=\"mlist_view()\">üìü</a><p>ÁßªÈô§ÊâÄÊúâÊèí‰ª∂ <a onclick=\"remove_plugins()\">üîå</a><p>ËøôÊòØÁî± <a href=\"https://t.me/duangsuse\">duangsuse</a> ÂºÄÂèëÁöÑ <a href=\"https://all-dream.com\">ÂÇ≤Ê¢¶</a> ÂàÜ‰∫´È°πÁõÆÊï∞ÊçÆÊü•ËØ¢Â∑•ÂÖ∑Ôºå‰ª• <strong>GNU LGPL-3.0</strong> ÂÖ±‰∫´ÂçèËÆÆÂºÄÊîæÊ∫ê‰ª£Á†Å<p><small>ÊÑüË∞¢ <strong>MDUI„ÄÅdownload.js„ÄÅMasonry</strong> Êèê‰æõÁöÑÈÉ®ÂàÜÁâπÊÄßÊîØÊåÅ<p><em>Âè¶Â§ñÔºåËØ∑Ê≥®ÊÑèÔºåÊü•ËØ¢Â∑•ÂÖ∑‰Ωú‰∏∫ÈôÑÂ±ûÁªÑ‰ª∂Ôºå‰∏çÂèóÊäÄÊúØÊîØÊåÅ</em></small></div><div>"
        for (var ipc = 0; ipc < plugins.length; ipc++) {
            toolset += '<p>' + plugins[ipc].menu + ' <a onclick="dslInterpreter(eval(\'JSON.parse(localStorage[\\\'plugins\\\'])[' + ipc + '].script\'), DSL_ON_MENU)">' + plugins[ipc].link + '</a>'
        }
        toolset += '</div>'
        // Menu
        $$('#title')[0].onclick = function () {
            $$.ajax({
                method: 'POST',
                url: 'https://all-dream.com/rest/share/queryCount',
                success: function (data) {
                    var obj = JSON.parse(data)
                    alert_title = mdui.alert("<a class=\"mdui-typo\">ÊÄªÂÖ±Êúâ <code>" + obj['total'] + "</code> ‰∏™‰ΩúÂìÅÔºåÂÖ∂‰∏≠ Scaratch <code>" + obj['SB2Count'] + "</code> ‰∏™ÔºåTJS <code>" + obj['JSCount'] + "</code> ‰∏™ÔºåÊÄùÁª¥ÂØºÂõæ <code>" + obj['mindMappingCount'] + "</code> ‰∏™ÔºåÊé®Ëçê <code>" + obj['promote'] + "</code> ‰∏™<p><small>‰Ω†ÂÆâË£ÖÊúâ <code>" + plugins.length + "</code> ‰∏™Êèí‰ª∂ÔºåÂΩìÂâçÂú®Á¨¨ " + pageNum + " È°µ</small></a>" + toolset);
                }
            });
        }

        // Refresh view
        pageNum = 1
        bin = []
        offical_prefix = 'https://all-dream.com/bigwall?id='
        $$('#refresh')[0].onclick = function () {
            bin = []
            var grab_snack = mdui.snackbar("Ê≠£Âú®‰ªéËøúÁ´ØËé∑ÂèñÂàóË°®...")
            // Angry! ‰∏∫Âï•Êàë‰∏çÁü•ÈÅìÊÄé‰πàÂÆö‰πâÂ±ÄÈÉ®ÂèòÈáè
            var start_time2 = new Date()
            rlist(pageNum, function (d) {
                grab_snack.close()
                mdui.snackbar("ÊàêÂäü‰ªéËøúÁ´ØËé∑ÂæóÂàóË°®ÔºåÁî®Êó∂ " + (new Date() - start_time2) / 1000 + " Áßí", { timeout: 500 })
                var buf = ""
                if (Object.keys(d['list']).length == 0)
                    if (pageNum != 0)
                        mdui.snackbar("Ê≥®ÊÑèÔºåÊàë‰ª¨Ë≤å‰ººËé∑Âæó‰∫Ü‰∏Ä‰∏™Á©∫ÂàóË°®ÔºåÂèØËÉΩÊòØÈ°µÈù¢Á¥¢ÂºïË∂ÖËøá‰∫ÜÂÆûÈôÖ‰∏äÁöÑÊúÄÂêé‰∏ÄÈ°µ", { timeout: 2500, buttonText: 'get back', onClick: function () { pageNum = 0 } });
                    else
                        mdui.snackbar("Ê≥®ÊÑèÔºåÊàë‰ª¨Ë≤å‰ººËé∑Âæó‰∫Ü‰∏Ä‰∏™Á©∫ÂàóË°®ÔºåËØ∑Ê£ÄÊü•ÂèÇÊï∞ÔºàÂ¶ÇÂàÜÁ±ªÔºâÊòØÂê¶Ê≠£Á°Æ", { timeout: 2000 });
                for (var k in d['list']) {
                    var v = d['list'][k]
                    // console.log(v)
                    bin[k] = v
                    item = fill('https://all-dream.com/' + v['coverUrl'], (v['courseTypeName'] == null ? 'Êó†ËØæÁ®ãÂàÜÁ±ª' : v['courseTypeName']) + ' - ' + v['name'] + 'Ôºà' + (v['grade'] == null ? 'Êó†Â≠¶Á∫ß' : v['grade']) + 'Ôºâ', v['shareTitle'] + ' | ‚≠êÔ∏è ' + v['star'] + ' üìù ' + v['score'] + ' üïê ' + tfmt(new Date(v['createTime'])) + ' üëÅ ' + v['visit'] + ' üíé ' + v['gold'] + ' | ' + (v['promote'] == 1 ? 'üëç' : '') + (v['sex'] == '1' ? 'üë¶üèª' : 'üëßüèª') + getSidLogo(v['shareType']), v['shareContent'], "window.location='https://all-dream.com/'+bin[" + k + "]['fileUrl']", "tmp=bin[" + k + "];download(JSON.stringify(tmp),'json_'+tmp['shareTitle']+'_'+tmp['name'],'application/json')", offical_prefix + v['id'])
                    buf += wrap(item)
                }
                setlist(buf);
                $$.showOverlay();
                $$.throttle(function () { refresh_mash(); $$.hideOverlay(); }, 1000)();

                // F**king mash
                $$.throttle(refresh_mash, 2000)();
                $$.throttle(refresh_mash, 4000)();
                $$.throttle(refresh_mash, 6000)();
                $$.throttle(refresh_mash, 10000)();
                $$.throttle(refresh_mash, 20000)();
                $$.throttle(refresh_mash, 25000)();
                $$.throttle(refresh_mash, 35000)();
                $$.throttle(refresh_mash, 40000)();
                $$.throttle(refresh_mash, 60000)();
                $$.throttle(refresh_mash, 65000)();

                // Áªô‰∫ÜÊàë‰ª£Á†ÅËøêË°åÂæàÂø´ÁöÑÈîôËßâ
                var tmp_pagesize = localStorage['page']
                if (localStorage['page'] > 700)
                    for (var it = 4; it < tmp_pagesize / 10; it += 100)
                        $$.throttle(refresh_mash, Math.abs(1000 << Math.round(it / 100)))();
            });
            autodark();
        }

        // Auto apply dark style
        autodark();

        // Support for hotkeys
        function do_refresh() { $$('#refresh').trigger('click') }
        document.onkeyup = function (k) {
            // Enter to refresh
            if (k.code == 'Enter') {
                if (k.target == $$('body')[0]) {
                    do_refresh();
                } else {
                    if (typeof diag_pagnum != 'undefined') {
                        // deprecated
                        // diag_pagnum.close();
                        // pagnum_ok();
                    }
                }
            }

            // console.log(k.code);
            switch (k.code) {
                case 'KeyM':
                    $$('#title').trigger('click');
                    break
                case 'ArrowRight':
                    $$('.mdui-fab').trigger('click');
                    break
                case 'ArrowLeft':
                    $$('#go-back').trigger('click');
                    break
                case 'KeyC':
                    $$('#btn-category').trigger('click');
                    break
                case 'KeyT':
                    $$('#pagnum').trigger('click');
            }
        }
    </script>

    <script>
        // Fill MDUI card view template
        var template = '<div class="mdui-card"><div class="mdui-card-media"><img src="@img@"/></div><div class="mdui-card-primary"><div class="mdui-card-primary-title">@title@</div><div class="mdui-card-primary-subtitle">@subtitle@</div></div><div class="mdui-card-content">@desc@</div><div class="mdui-card-actions"><button onclick="@a1@" class="mdui-btn mdui-ripple mdui-color-theme-accent mdui-btn-raised"><i class="mdui-icon mdui-icon-left material-icons">file_download</i> ‰∏ãËΩΩ</button><button onclick="@a2@" class="mdui-btn mdui-btn-raised mdui-ripple"><i class="mdui-icon mdui-icon-left material-icons">info_outline</i> Ê∫êÊï∞ÊçÆ</button><a href="@a3@" class="mdui-float-right mdui-btn mdui-btn-raised mdui-btn-icon mdui-ripple"><i class="mdui-icon material-icons">insert_link</i></a></div></div>'
        function fill(img, title, subt, desc, a1, a2, a3) {
            return template.replace('@img@', img)
                .replace('@title@', title)
                .replace('@subtitle@', subt)
                .replace('@desc@', desc)
                .replace('@a1@', a1)
                .replace('@a2@', a2)
                .replace('@a3@', a3);
        }

        // Wrap map item
        function wrap(h) {
            return '<div class="grid-item mdui-shadow-5 mdui-grid-tile mdui-grid-list">' + h + '</div>'
        }
    </script>

    <!-- Main list -->
    <div id="list" style="padding: 10px;" class="grid mdui-container-fluid"></div>
    <script>
        var list = $$('#list')[0]
        // Stream layout support
        function refresh_mash() {
            var msnry = new Masonry(list, {
                itemSelector: '.grid-item',
                columnWidth: 30
            });
        }

        // URL handlers
        function show_user(uid) {
            console.log("Show user JSON: " + uid)
            ruser(uid, function (d) { pplist(d) });
        }

        function show_share(sid) {
            console.log("Show share JSON: " + sid)
            rproj(sid, function (d) { pplist(d) });
        }

        function show_list() {
            console.log("Show list: " + query['category'] + ' ' + pageNum + '/' + localStorage['page'])
            localStorage['cate'] = query['category']
            do_refresh();
        }

        // Simple plugin system for AllDreamWall
        github_api = 'https://api.github.com/'
        github_gist_api = 'https://api.github.com/gists/'

        // plugin handlers, plugin initialize call will use this map
        plugin_url_handlers = {}

        // JSON commenter
        plugin_emitters = {}

        // DSL environment map
        dsl = {}

        // GH API Helper
        function getDynamicGistUrl(fun) {
            $$.ajax({
                method: 'GET',
                url: github_api,
                success: fun
            });
        }

        rid = /(?:^|\s)plugin (.*)(?:\s|$)/g
        rau = /(?:^|\s)author (.*)(?:\s|$)/g
        rdesc = /(?:^|\s)description (.*)(?:\s|$)/g
        // A.k.a plugin-install
        function pluginify(gist_id) {
            console.log("PluginInstall: Gist#" + gist_id)
            if (typeof gist_id == 'undefined') {
                mdui.snackbar("Plugin-install ÈúÄË¶ÅÊé•Âèó gist_id ÂèÇÊï∞", { timeout: 2000 })
                return;
            }
            var target_plugin = {} // Create POM
            var gh_fetch_bar = mdui.snackbar("Ê≠£Âú®‰ªé GitHub ÊãâÂèñÊèí‰ª∂‰ø°ÊÅØ...", { timeout: 7000 });
            $$.ajax({
                method: 'GET',
                url: github_gist_api + gist_id,
                success: function (s) {
                    var ghson_parsed = JSON.parse(s)
                    var p_id, p_author, p_desc, p_menu, p_link, p_script = null
                    if (typeof ghson_parsed['files']['description.dreamplugin'] != 'undefined') {
                        // Usable gist
                        var tmp_parse = ghson_parsed['files']['description.dreamplugin']['content']
                        p_id = rid.exec(tmp_parse)[1]
                        p_author = rau.exec(tmp_parse)[1]
                        p_desc = rdesc.exec(tmp_parse)[1]
                        p_menu = /(?:^|\s)menuitem (.*) link (.*)(?:\s|$)/g.exec(tmp_parse)[1]
                        p_link = /(?:^|\s)menuitem (.*) link (.*)(?:\s|$)/g.exec(tmp_parse)[2]
                        if (typeof ghson_parsed['files']['plugin.dreamscript'] != 'undefined') {
                            // Usable installer
                            p_script = ghson_parsed['files']['plugin.dreamscript']['content']
                        } else {
                            mdui.snackbar("‰∏çËÉΩÂÆâË£Ö " + ghson_parsed['owner']['login'] + " ÁöÑÊèí‰ª∂ÔºöÂÆÉÊ≤°Êúâ‰ª£Á†Å")
                            return;
                        }
                    } else {
                        mdui.snackbar("‰∏çËÉΩÂÆâË£Ö " + ghson_parsed['owner']['login'] + " ÁöÑÊèí‰ª∂ÔºöÂÆÉÊ≤°ÊúâÂÖÉÊï∞ÊçÆ")
                        return;
                    }
                    // ÂèØËÉΩËøòÊòØÊúâÂÆâÂÖ®ÈóÆÈ¢òÂêßÔºüÁÆó‰∫Ü Â¶ÇÊûúÊúâÈóÆÈ¢òÊä•Êàë
                    if ((p_id + p_author + p_desc).includes('script')) {
                        mdui.snackbar("ÂÖÉÊï∞ÊçÆÂèØËÉΩÂê´Êúâ‰∏çÂÖÅËÆ∏ÁöÑ HTML Ê†áÁ≠æÔºåÈòªÊ≠¢ÂÆâË£Ö");
                        return;
                    }
                    gh_fetch_bar.close()
                    console.log("InstallPlugin: " + p_id + p_author + p_desc + p_menu + p_link + p_script)
                    mdui.confirm("<div class=\"mdui-typo\">ÁúüÁöÑË¶ÅÂÆâË£ÖÊù•Ëá™ " + p_author + "ÔºàGitHub Â∏êÂè∑ " + ghson_parsed['owner']['login'] + "Ôºâ ÁöÑÊèí‰ª∂ <a href=\"" + "https://gist.github.com/" + gist_id + '">' + p_id + "</a> ÂêóÔºü<p><h5><strong>Êèí‰ª∂ÊèèËø∞</strong></h5><p>" + p_desc + "<p><small><em>Â¶ÇÊûú‰Ω†‰∏çÊòéÁôΩ‰Ω†Âú®ÂÅö‰ªÄ‰πàÔºåËØ∑‰∏çË¶ÅÊ∑ªÂä†Êèí‰ª∂</em></small></div>", function (d) {
                        target_plugin.id = p_id
                        target_plugin.author = p_author
                        target_plugin.description = p_desc
                        target_plugin.menu = p_menu
                        target_plugin.link = p_link
                        target_plugin.script = p_script
                        // Install plugin now
                        plugins.push(target_plugin)
                        localStorage['plugins'] = JSON.stringify(plugins)
                        d.close();
                        mdui.snackbar("Â∑≤ÁªèÂÆâË£ÖÊèí‰ª∂ <strong>" + p_id + "</strong> Âà∑Êñ∞‰ª•ÂêØÁî®", { timeout: 3000 });
                        dslInterpreter(p_script, DSL_ON_INSTALL)
                    }, function (d) { d.close(); gh_fetch_bar() }, { confirmOnEnter: true })
                }
            });
        }

        DSL_ON_INITIALIZE = undefined
        DSL_ON_MENU = 1
        DSL_ON_URL = 2
        DSL_ON_INSTALL = 3
        // Interpreter for AllDreamWall plugin DSL
        // invokeType undefined: execute main script(initialize ... end)
        // invokeType 1: menu link clicked(execute begin ... end)
        // invokeType 2: url type(execute urlhandle ... end)
        // invokeType 3: register JSON prettifier comment gen. (execute jsoncomment ... end) (obsoleted, called once on installation)
        // DreamScript WIP, current interpreter is ESVM
        function dslInterpreter(code, invokeType) {
            try {
                switch (invokeType) {
                    case DSL_ON_INITIALIZE:
                        efun = eval(code); efun('initialize');
                        break
                    case DSL_ON_MENU:
                        efun = eval(code); efun('on_menu');
                        break
                    case DSL_ON_URL:
                        efun = eval(code); efun('on_url');
                        break
                    case DSL_ON_INSTALL:
                        efun = eval(code); efun('install');
                        break
                    default:
                        mdui.snackbar("Êèí‰ª∂Á≥ªÁªüÈîôËØØÔºödsl Ëß£ÈáäÂô®Êó†Ê≥ïÁêÜËß£ invokeType: " + invokeType, { timeout: 3000 });
                }
            } catch (error) {
                if (error instanceof SyntaxError) {
                    mdui.snackbar("Êèí‰ª∂Á≥ªÁªüÈîôËØØÔºödsl Ëß£ÈáäÂô®Êó†Ê≥ïÁêÜËß£‰ª£Á†Å: " + error.message, { timeout: 4000 });
                } else if (error instanceof TypeError) {
                    mdui.snackbar("Êèí‰ª∂Á≥ªÁªüÈîôËØØÔºödsl Ëß£ÈáäÂô®Á±ªÂûã: " + error.message, { timeout: 4500 });
                } else {
                    mdui.snackbar("Êèí‰ª∂Á≥ªÁªüÈîôËØØÔºö" + error.toString(), { timeout: 4000 });
                }
            }
        }

        // Serial, execute a function with query data
        function temp_change_pagNum_rows(fun) {
            pageNum_old = pageNum
            pageNum = query['page'] || pageNum_old
            rows_old = localStorage['page']
            localStorage['page'] = query['rows'] || rows_old
            fun();
            pageNum = pageNum_old
            localStorage['page'] = rows_old
        }

        // Call initialize function
        // Plugin map contains:
        // plugin ID
        // plugin author
        // plugin desc
        // plugin menuitem
        // plugin link text
        // plugin script

        plugins.forEach(function (p) { dslInterpreter(p.script, DSL_ON_INITIALIZE) })
        // dslInterpreter(p.script, DSL_ON_INITIALIZE)

        // URL Param support
        if (Object.keys(query).length != 0) {
            switch (query['type']) {
                case undefined:
                case null:
                    mdui.snackbar('ÊÇ®ÁöÑËØ∑Ê±ÇÂê´ÊúâÂèÇÊï∞Ôºå‰ΩÜÊòØÊ≤°ÊúâÊåáÊòéÊìç‰ΩúÁ±ªÂûãÔºåÂèÇÊï∞Â∞ÜË¢´ÂøΩÁï•');
                    break;

                case 'user':
                    show_user(query['uid'])
                    break;

                case 'work':
                    show_share(query['sid'])
                    break;

                case 'shared_messages':
                    temp_change_pagNum_rows(slist_view);
                    break;

                case 'source':
                    temp_change_pagNum_rows(mlist_view);
                    break;

                case 'bill_gem':
                    temp_change_pagNum_rows(gem_view)
                    break;

                case 'bill_gold':
                    temp_change_pagNum_rows(gold_view)
                    break;

                case 'list':
                    temp_change_pagNum_rows(show_list)
                    break;

                case 'show_about':
                    $$('#title').trigger('click');
                    break;

                case 'plugin':
                    pluginify(query['gist_id'])
                    break;

                default:
                    if (typeof plugin_url_handlers[query['type']] != 'undefined') {
                        dslInterpreter(plugin_url_handlers[query['type']].script, DSL_ON_URL)
                    } else {
                        mdui.snackbar('Êó†Ê≥ïÁêÜËß£Êìç‰ΩúÁ±ªÂûãÔºö' + query['type'])
                    }
                    break;
            }
        }
    </script>

    <!-- Next page fab -->
    <button onclick="pageNum++; mdui.snackbar('ÂâçËøõ‰∏ÄÈ°µÔºö' + pageNum, { timeout: 500 })" class="mdui-fab mdui-fab-fixed mdui-color-theme-accent mdui-ripple">
        <i class="mdui-icon material-icons">arrow_forward</i>
    </button>

    <!-- category dialog -->
    <div class="mdui-dialog" id="set-category">
        <div class="mdui-dialog-title">ËØ∑ÈÄâÊã©Ë¶ÅÊòæÁ§∫ÁöÑÂàÜÁ±ª</div>
        <div class="mdui-dialog-content mdui-typo">ÊÇ®ÂèØ‰ª•ÈÄâÊã©Âè™ÊòæÁ§∫ÊåáÂÆöÁ±ªÂûãÁöÑÈ°πÁõÆÔºåÂåÖÊã¨
            <code>ÂÖ®ÈÉ®„ÄÅMindMap„ÄÅScratch„ÄÅJS Turtle„ÄÅÊé®Ëçê</code>
        </div>
        <div class="mdui-dialog-actions mdui-dialog-actions-stacked">
            <button onclick="s('all')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show All | ÊòæÁ§∫ÂÖ®ÈÉ®</button>
            <button onclick="s('mindmap')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show Mind-Maps | MindMap</button>
            <button onclick="s('scratch')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show Scratch Projects | Scratch </button>
            <button onclick="s('turtle')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Show JS Turtle Projects | JS Turtle</button>
            <button onclick="s('recommended')" class="mdui-btn mdui-ripple" mdui-dialog-confirm="">Recommended Projects | Êé®ËçêÈ°πÁõÆ</button>
            <button class="mdui-btn mdui-ripple" mdui-dialog-close="">Keep settings, close dialog | ‰øùÊåÅÁé∞Áä∂</button>
        </div>
    </div>
</body>

</html>
